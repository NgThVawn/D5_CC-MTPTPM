@using WebBanHang.Models
@model WebBanHang.Models.Promotion

@{
    ViewData["Title"] = "Chi tiết khuyến mãi";
    var now = DateTime.Now;
    var isExpired = Model.EndDate <= now;
    var remaining = Model.EndDate - now;
    var statusText = isExpired
        ? "Đã hết hạn"
        : (Model.IsActive ? "Đang hoạt động" : "Đã tắt");
    var statusClass = isExpired ? "danger" : (Model.IsActive ? "success" : "secondary");
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

<style>
    .promo-box {
        background: #fff;
        border-radius: 1rem;
        padding: 2rem;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.05);
        height: 100%;
    }

    .promo-item {
        margin-bottom: 1.5rem;
    }

        .promo-item i {
            margin-right: 0.5rem;
            color: var(--bs-primary);
        }

    .promo-label {
        font-weight: 600;
        color: #444;
        margin-bottom: 0.3rem;
    }

    .promo-value {
        font-size: 0.95rem;
        color: #222;
    }

    .badge-status {
        font-size: 0.9rem;
        padding: 0.4rem 0.8rem;
        border-radius: 0.5rem;
    }

    @@media (max-width: 768px) {
        .row > div

    {
        margin-bottom: 1.5rem;
    }

    }
</style>

<div class="container py-5">
    <h2 class="mb-4 fw-bold text-primary">
        <i class="fa-solid fa-percent me-2"></i> Chi tiết chương trình khuyến mãi
    </h2>

    <div class="row g-4">
        <!-- Cột trái -->
        <div class="col-md-6">
            <div class="promo-box">
                <div class="promo-item">
                    <div class="promo-label"><i class="fa-solid fa-tag"></i> Tên chương trình</div>
                    <div class="promo-value">@Model.Name</div>
                </div>

                <div class="promo-item">
                    <div class="promo-label"><i class="fa-solid fa-align-left"></i> Mô tả</div>
                    <div class="promo-value">@Model.Description</div>
                </div>

                <div class="promo-item">
                    <div class="promo-label"><i class="fa-solid fa-percent"></i> Giá trị giảm</div>
                    <div class="promo-value">
                        @(Model.DiscountType == DiscountType.Percentage
                                                ? Model.DiscountValue + "%"
                                                : Model.DiscountValue.ToString("N0") + " đ")
                    </div>
                </div>
            </div>
        </div>

        <!-- Cột phải -->
        <div class="col-md-6">
            <div class="promo-box">
                <div class="promo-item">
                    <div class="promo-label"><i class="fa-solid fa-calendar-days"></i> Thời gian áp dụng</div>
                    <div class="promo-value">
                        @Model.StartDate.ToString("dd/MM/yyyy HH:mm") → @Model.EndDate.ToString("dd/MM/yyyy HH:mm")
                    </div>
                </div>

                <div class="promo-item">
                    <div class="promo-label"><i class="fa-solid fa-clock"></i> Thời gian còn lại</div>
                    <div class="promo-value">
                        @if (isExpired)
                        {
                            <span class="text-danger fw-bold">Đã hết hạn</span>
                        }
                        else
                        {
                            <span class="countdown-timer text-danger fw-semibold"
                                  data-end="@Model.EndDate.ToString("yyyy-MM-ddTHH:mm:ss")">
                                Đang tính...
                            </span>
                        }
                    </div>
                </div>

                <div class="promo-item">
                    <div class="promo-label"><i class="fa-solid fa-circle-info"></i> Trạng thái</div>
                    <div class="promo-value">
                        <span class="badge bg-@statusClass badge-status">@statusText</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Nút quay lại -->
    <div class="mt-4">
        <a asp-action="Index" class="btn btn-secondary">
            <i class="fa-solid fa-arrow-left me-1"></i> Quay lại danh sách
        </a>
    </div>
</div>

<script>
    function updateCountdowns() {
        document.querySelectorAll('.countdown-timer').forEach(span => {
            const endTime = new Date(span.dataset.end);
            const now = new Date();

            let diff = endTime - now;

            if (diff <= 0) {
                span.innerText = 'Đã hết hạn';
                return;
            }

            const end = new Date(endTime);
            const current = new Date(now);

            // Tính số tháng
            let months = (end.getFullYear() - current.getFullYear()) * 12 + (end.getMonth() - current.getMonth());
            let temp = new Date(current);
            temp.setMonth(temp.getMonth() + months);

            if (temp > end) {
                months--;
                temp.setMonth(temp.getMonth() - 1);
            }

            // Sau khi trừ tháng → còn lại là miligiây
            let remainingMs = endTime - temp;

            const days = Math.floor(remainingMs / (1000 * 60 * 60 * 24));
            const hours = Math.floor((remainingMs / (1000 * 60 * 60)) % 24);
            const minutes = Math.floor((remainingMs / (1000 * 60)) % 60);
            const seconds = Math.floor((remainingMs / 1000) % 60);

            let parts = [];
            if (months > 0) parts.push(`${months} tháng`);
            if (days > 0) parts.push(`${days} ngày`);
            if (hours > 0 || days > 0 || months > 0) parts.push(`${hours} giờ`);
            if (minutes > 0 || hours > 0 || days > 0 || months > 0) parts.push(`${minutes.toString().padStart(2, '0')} phút`);
            parts.push(`${seconds.toString().padStart(2, '0')} giây`);

            span.innerText = parts.join(' ');
        });
    }

    setInterval(updateCountdowns, 1000);
    window.onload = updateCountdowns;
</script>
